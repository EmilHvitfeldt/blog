---
title: Deploy your bookdown project to Netlify with Github Actions
author: Emil Hvitfeldt
date: '2020-01-20'
slug: bookdown-netlify-github-actions
categories: []
tags: []
type: "blog"
showonlyimage: false
weight: 1
image: "/img/blog/bookdown-netlify-github-actions/cover.png"
description: "Seamlessly Deploy your bookdown project to Netlify with Github Actions."
output:
  blogdown::html_page:
    toc: true
---

```{r setup, include=FALSE}
library(knitr)
opts_chunk$set(
  echo = TRUE,
  cache = TRUE,
  fig.width = 7, 
  fig.align = 'center',
  fig.asp = 0.618, # 1 / phi
  out.width = "700px")
knit_hooks$set(optipng = hook_optipng)
opts_chunk$set("optipng" = "-o5")
```

With the new [Github Actions](https://github.com/features/actions) comes many possibilities. 
Some new and some old.
One of the benefits is that you don't have to use third-party applications to do continuous integration.

This post will show you how you can set up a [bookdown](https://bookdown.org/yihui/bookdown/) site with [Netlify](https://netlify.com/) using Github Actions.
This was previously and still is possible to do with Travis-CI.

This post wouldn't have been possible without [Jim Hester's](https://twitter.com/jimhester_) work on [Github Actions](https://github.com/r-lib/actions).

If you are transferring a book from Travis-CI build look at the notes at the end of this post.

## Create Repository

First, you need to create a bookdown repository. 
For this, I suggest you follow the [Getting Started](https://bookdown.org/yihui/bookdown/get-started.html) chapter from the [Bookdown Book](https://bookdown.org/yihui/bookdown/) and download the GitHub repository https://github.com/rstudio/bookdown-demo as a [Zip file](https://github.com/rstudio/bookdown-demo/archive/master.zip), then unzip it locally.
I recommend that you change the name of the `.Rproj` file so isn't the default value.

The next step isn't necessary but is still highly recommended.
Go fill in the information in the `DESCRIPTION` file.
Most importantly the `Package` and `Title` fields.
The `Package` field will be used as the name of the repository and the `Title` field will be the description of the repository once it hits Github.

## Connect to Github

Now we want to connect our repository to Github.
For this, I will use the [usethis](https://usethis.r-lib.org/) package which is wonderful for things like this.
If you haven't used **usethis** before please go do the [usethis setup](https://usethis.r-lib.org/articles/articles/usethis-setup.html) before moving forward.

Simply add Git to the repository by running `usethis::use_git()` and connect it to Github with `usethis::use_github()`.
This should open up a webpage with the newly linked repository.

## Create Netlify account

If you haven't already got a Netlify account, go to [netlify.com/](https://www.netlify.com/) to create one for free.
I have it set up with Github for easier interaction.

## Create Netlify site

Once you have logged into Netlify go to your team page and to create a "New site from Git"

![](/img/blog/bookdown-netlify-github-actions/netlify-teams.png)

Select Github for Continuous Deployment

![](/img/blog/bookdown-netlify-github-actions/create-new-site.png)

Now we need to select the GitHub repository.
Depending on how many repositories you have you can find it in the list or search for it with the search bar.
Once you have found it click the little arrow to the right of it.

![](/img/blog/bookdown-netlify-github-actions/pick-a-repository.png)

Don't touch any of the settings.

![](/img/blog/bookdown-netlify-github-actions/deploy-settings.png)

And voila!
Here is your new site, it is currently empty. 
Now click on the "Site settings" button

![](/img/blog/bookdown-netlify-github-actions/new-site.png)

copy the API ID and save it, you will need it in a little bit.
If you lose it you can always come back here and copy it again.

![](/img/blog/bookdown-netlify-github-actions/site-id.png)

You might have noticed that the website is completely random.
If you click on the "Change site name" button you can set a new prefix name.

![](/img/blog/bookdown-netlify-github-actions/set-name.png)

Scroll down to get the Status Badge, you can copy this too and put it in the top of your README.md file if you want.

![](/img/blog/bookdown-netlify-github-actions/status-badge.png)

## Get a Netlify personal access token

Scroll all the way up and click on your icon in the top right corner.
Then go to "User settings"

![](/img/blog/bookdown-netlify-github-actions/icon.png)

go to "Applications"

![](/img/blog/bookdown-netlify-github-actions/user-settings.png)

And click on "New access token" to create a personal access token

![](/img/blog/bookdown-netlify-github-actions/personal-access-token.png)

The description of your token isn't important but try to make it related to your book so you remember.
Click "Generate token" when you are done.

![](/img/blog/bookdown-netlify-github-actions/generate-token.png)
Here is your authentication token. 
Copy it and don't lose it!
Once you leave this site you can get it back.

![](/img/blog/bookdown-netlify-github-actions/created-token.png)

## Store Your Secrets

Now that you have the API ID and personal access token go back to your Github repository and go to "Settings"

![](/img/blog/bookdown-netlify-github-actions/github-settings.png)

go to "Secrets"

![](/img/blog/bookdown-netlify-github-actions/github-secrets.png)

Click on "Add a new secret"

![](/img/blog/bookdown-netlify-github-actions/add-new-secret.png)

You need to do this twice.

- one named "NETLIFY_AUTH_TOKEN" where you put the personal access token as the value and,
- one named "NETLIFY_SITE_ID" where you put the API ID as the value.

![](/img/blog/bookdown-netlify-github-actions/fill-in-secret.png)

## Create Github workflow

Now add the GitHub workflow file.
If you don't already add a folder called `.github/workflows`.
This can be done from R with the [fs](https://github.com/r-lib/fs) package.

```{r, eval=FALSE}
fs::dir_create(".github/workflows")
```

next, create a .yml file in that folder. 
The name doesn't matter, but I'm calling it `bookdown.yml`.
It can be a little hard to create a file in a secret folder so you can create it with

```{r, eval=FALSE}
fs::file_create(".github/workflows/bookdown.yaml")
```

If you can see the file look [here](https://github.com/rstudio/rstudio/issues/1769) for help.

Copy-paste the following code into the file and save it. 
You don't need to modify anything.
This is a modify version of from [r-lib/actions](https://github.com/r-lib/actions/tree/master/examples#build-bookdown-site).

```{}
on:
  push:
    branches: master

jobs:
  build:
    runs-on: macOS-latest
    steps:
      - name: Checkout repo
        uses: actions/checkout@master

      - name: Setup R
        uses: r-lib/actions/setup-r@master

      - name: Install pandoc and pandoc citeproc
        run: |
          brew install pandoc
          brew install pandoc-citeproc

      - name: Cache Renv packages
        uses: actions/cache@v1
        with:
          path: $HOME/.local/share/renv
          key: r-${{ hashFiles('renv.lock') }}
          restore-keys: r-

      - name: Cache bookdown results
        uses: actions/cache@v1
        with:
          path: _bookdown_files
          key: bookdown-${{ hashFiles('**/*Rmd') }}
          restore-keys: bookdown-

      - name: Install packages
        run: |
          R -e 'install.packages("renv")'
          R -e 'renv::restore()'

      - name: Build site
        run: Rscript -e 'bookdown::render_book("index.Rmd", quiet = TRUE)'

      - name: Install npm
        uses: actions/setup-node@v1

      - name: Deploy to Netlify
        # NETLIFY_AUTH_TOKEN added in the repo's secrets
        env:
          NETLIFY_AUTH_TOKEN: ${{ secrets.NETLIFY_AUTH_TOKEN }}
          NETLIFY_SITE_ID: ${{ secrets.NETLIFY_SITE_ID }}
        run: |
          npm install netlify-cli -g
          netlify deploy --prod --dir _book
```

## Run renv::snapshot

Install the [renv](https://github.com/rstudio/renv) package and run `renv::snapshot()`.
This will ensure the package versions remain consistent across builds.

Once you need more packages, add them to the description like you normally would with an R package.

## Push changes

And that is everything you need to do, just commit the workflow file and the **renv** files you created and the website should build for you.

My example can be found [here](https://bookdown-github-actions-netlify.netlify.com/) with the [repository](https://github.com/EmilHvitfeldt/bookdown-github-actions-netlify).

## Notes

the line

```{}
netlify deploy --prod --dir _book
```

in the workflow file it the one that deploys the built book to Netlify. 
It defaults to the `_book` folder.
In the `_bookdown.yml` file you can change the output folder.
So if you have set it to `output_dir: "docs"` then you need to change the deploy option to

```{}
netlify deploy --prod --dir docs
```

